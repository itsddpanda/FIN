# --- Builder Stage ---
FROM python:3.10-slim-buster AS builder

# Install system dependencies (if any)
RUN apt-get update && apt-get install -y --no-install-recommends cron \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements
COPY requirements.txt .

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Compile Python code
RUN python -m compileall .

# --- Final Stage ---
FROM python:3.10-slim-buster AS final

RUN apt-get update && apt-get install -y --no-install-recommends cron \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy compiled code and dependencies from builder
COPY --from=builder /app/__pycache__ /app/__pycache__
COPY --from=builder /app/alembic /app/alembic
COPY --from=builder /app/alembic.ini /app/alembic.ini
COPY --from=builder /app/auth.py /app/auth.py
COPY --from=builder /app/check_log.sh /app/check_log.sh
COPY --from=builder /app/cronrun.py /app/cronrun.py
COPY --from=builder /app/crontab /app/crontab
COPY --from=builder /app/db.py /app/db.py
COPY --from=builder /app/entrypoint.sh /app/entrypoint.sh
COPY --from=builder /app/logging_config.py /app/logging_config.py
COPY --from=builder /app/main.py /app/main.py
COPY --from=builder /app/models.py /app/models.py
COPY --from=builder /app/routes /app/routes
COPY --from=builder /app/schemas.py /app/schemas.py
COPY --from=builder /app/static /app/static
COPY --from=builder /app/templates /app/templates

COPY .env /app/.env
COPY check_log.sh /app/check_log.sh
# Copy crontab file
COPY crontab /etc/cron.d/log-check-cron

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
RUN chmod +x /app/check_log.sh
RUN chmod 0644 /etc/cron.d/log-check-cron
# RUN crontab /etc/cron.d/log-check-cron

# Start cron service and the main app
# CMD cron && tail -f /dev/null
# Expose the application port
EXPOSE 8000

# Set entrypoint script
# ENTRYPOINT ["/entrypoint.sh"]
CMD ["python", "main.py"]
# , "--host", "0.0.0.0", "--port", "8000"]